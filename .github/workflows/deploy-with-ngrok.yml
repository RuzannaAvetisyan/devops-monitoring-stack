name: Deploy with Public Access
on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'How long to keep tunnel open (minutes)'
        required: false
        default: '30'
      branch:
        description: 'Branch to deploy'
        required: false
        default: 'feature/github-actions-deploy'
  push:
    branches:
      - feature/github-actions-deploy

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check system
        run: |
          echo "Running on: $(uname -s)"
          echo "Architecture: $(uname -m)"
          docker --version

      - name: Stop existing services
        run: docker compose down || true

      - name: Start services
        run: docker compose up -d

      - name: Start Ngrok tunnel
        run: |
          ngrok http 3000 --log=stdout > ngrok.log &
          sleep 5

      - name: Get public URL
        run: |
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "ðŸŽ‰ Dashboard: $NGROK_URL"